---
title: "Analysis examples in DeepTarget"
output: 
  BiocStyle::html_document
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{Analysis examples in DeepTarget}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)
```

# Core Analysis

The core analyis includes loading the necessary data, performing the core analysis, and saving
the results. For a given drug, the core analysis includes generating a similarity score between the viability
after drug treatment and each gene knockout, computing if the drug may differentially bind to the
known drug target mutant form or WT form, by calculating this similarity in cell lines with known
target WT vs. mutant form, and finally, finding the secondary targets of the drug by repeating this
analysis in the cell lines where the primary target is not expressed.

## Data Loading and Preparation
The script loads OntargetM object and prepare the matrix for viability after drug treatment for the
drugs that we are interested in and the matrix of Gene effect scores after CRISPR-KO.

```{r Data Loading and Preparation}
library(DeepTarget)
data("OntargetM")
print ( "Below is the OnTargetM object containing a subset of public data downloading from depmap.org")
sapply(OntargetM,dim)
dir.create('./result/')
## drug interest.
drug.name <- c('atiprimod','AMG-232','pitavastatin','Ro-4987655','alexidine','RGFP966','dabrafenib','olaparib','CGM097','ibrutinib','palbociclib')
print ( " we will focus on these drugs:");
print (drug.name);
## prepare data for these drugs.
idx.Drug <- which(OntargetM$DrugMetadata$name %in% drug.name)
S.Drug <- OntargetM$DrugMetadata$broad_id_trimmed [idx.Drug]
idx.DrugN <- which(row.names(OntargetM$secondary_prism) %in% S.Drug)
sec.prism.f <- OntargetM$secondary_prism[idx.DrugN, ]
KO.GES <- OntargetM$avana_CRISPR

```
## Computing Similarity Between Drug Treatment and Gene Knockout
The script computes the similarity Between Drug Treatment and Gene Knockout using GetSim
function.

```{r Computing Similarity Between Drug Treatment and Gene Knockout}
List.sim <- NULL;
for (i in 1:nrow(sec.prism.f)){
DRS=as.data.frame(sec.prism.f[i,])
DRS <- t(DRS)
row.names(DRS) <- row.names(sec.prism.f)[i]
out <- GetSim(row.names(sec.prism.f)[i],DRS=DRS, GES=KO.GES)
List.sim [[length(List.sim) + 1]] <- out
}
names(List.sim) <- row.names(sec.prism.f)
saveRDS(List.sim,file = 'Result/similarity_KO_DrugTreatment.RDS')
```

## Performing Pathway Analysis Based on Drug Meta Data

The script performs the pathway analyis based on the drug metadata using DoPWY function.

```{r Performing Pathway Analysis Based on Drug Meta Data}
metadata <- OntargetM$DrugMetadata
Pwy.Enr <- DoPWY(Sim.GES.DRS=List.sim,D.M = metadata)
saveRDS(Pwy.Enr,
file = 'Result/Pwy.Enrichment.RDS')
```

### Predicting Similarity Across Known Targeted Genes and All Genes
The script predicts similarity Across Known Targeted Genes and All Genes using PredTarget and PredMaxSim functions.

```{r section.cap="Predicting Similarity Across Known Targeted Genes and All Genes"}
DrugTargetSim <- PredTarget(Sim.GES.DRS=List.sim, D.M=metadata)
DrugGeneMaxSim <- PredMaxSim(Sim.GES.DRS=List.sim, D.M=metadata)
```

## Computing the Interaction
The script computes the interaction between the drug and knockout (KO) gene expression in terms of both mutant vs non-mutant and lower vs higher expression using function DoInteractExp, and DoInteractMutant.

```{r section.cap="Computing the Interaction"}
d.mt <- OntargetM$mutations_mat
d.expr <- OntargetM$expression_20Q4
out.MutantTarget <- NULL;
out.LowexpTarget <- NULL;
for (i in 1:nrow(sec.prism.f)){
DRS=as.data.frame(sec.prism.f[i,])
DRS <- t(DRS)
row.names(DRS) <- row.names(sec.prism.f)[i]
## for mutant
Out.M <- DoInteractMutant(Predtargets=DrugTargetSim[i,],
Mutant=d.mt,DRS=DRS,GES=KO.GES)
TargetMutSpecificity <- data.frame(MaxTgt_Inter_Mut_strength=
sapply(Out.M, function(x) x[1]),
MaxTgt_Inter_Mut_Pval=sapply(Out.M, function(x) x[2]))
out.MutantTarget <- rbind (out.MutantTarget,TargetMutSpecificity)
## for expression.
Out.Expr <- DoInteractExp(DrugTargetSim[i,],d.expr,
DRS=DRS,GES=KO.GES,CutOff = 2)
TargetExpSpecificity <- data.frame(
MaxTgt_Inter_Exp_strength=
sapply(Out.Expr, function(x) x[1]),
MaxTgt_Inter_Exp_Pval=
sapply(Out.Expr, function(x) x[2])
)
out.LowexpTarget <- rbind ( out.LowexpTarget,TargetExpSpecificity)
}
```

## Interaction Assessment


This part of the script assesses whether the interaction is true or false based on a certain cut-off, and computes the p-value from a linear model.
```{r Interaction Assessment}
Whether_interaction_Ex_based= ifelse( out.LowexpTarget$MaxTgt_Inter_Exp_strength <0
& out.LowexpTarget$MaxTgt_Inter_Exp_Pval <0.2,TRUE,FALSE)
predicted_resistance_mut= ifelse(
out.MutantTarget$MaxTgt_Inter_Mut_Pval<0.1,TRUE,FALSE)
```

## Preparation for Output

Lastly, the script gathers the results into a final data frame and writes it to a CSV file.

```{r Preparation for Output}
Pred.d <- NULL;
Pred.d <- cbind(DrugTargetSim,
DrugGeneMaxSim,out.MutantTarget,
predicted_resistance_mut)
mutant.C <- sapply(Pred.d[,3],function(x)errHandle(sum(d.mt[x,] ==1)))
Pred.d$mutant.C <- mutant.C
Low.Exp.C = sapply(Pred.d[,3],
function(x)errHandle(sum(d.expr[x,] < 2))) 
Pred.d <- cbind(Pred.d, out.LowexpTarget, Whether_interaction_Ex_based,Low.Exp.C)
FileN <- "./Result/Prediction_sim_KO_DrugTreatment_CoreAnalysis.csv"
write.csv (Pred.d, FileN)
```
## In addition to the output of prediction object, we also identify drugs with low primary target expressing cell lines
For the drugs where the primary target is not expressed in at least five cell lines, we will identify
their secondary target below. This section identifies primary target genes that are not expressed in
at least 5 cell lines.

```{r Identifying Drugs with low primary target expressing cell lines}
Low.i <- which(Pred.d$Low.Exp.C >5)
Pred.d.f <- Pred.d[ Low.i,]
Low.Exp.G = sapply(Pred.d.f[,3],
function(x) errHandle(names(which(d.expr[x,]<2))))
identical (names(Low.Exp.G),Pred.d.f[,3] )
sim.LowExp <- NULL;
sec.prism.f.f <- sec.prism.f[Low.i,]
identical (row.names(sec.prism.f.f) ,Pred.d.f[,1])
```
## Calculating Drug KO Similarities in cell lines with low primary target
The following script performs calculations to determine DKS score in cell lines with low primary
target expression. This DKS score is called Secondary DKS Score and denotes the secondary target
probability.
```{r Calculating Drug KO Similarities in cell lines with low primary target}
for (i in 1:nrow(Pred.d.f)){
DRS.L= sec.prism.f.f[i,Low.Exp.G[[unlist(Pred.d.f[i,3])]]]
DRS.L <- t(as.data.frame(DRS.L))
row.names(DRS.L) <- Pred.d.f[i,1]
out <- GetSim(Pred.d.f[i,1],DRS=DRS.L, GES=KO.GES)
sim.LowExp [[length(sim.LowExp) + 1]] <- out
}
names(sim.LowExp) <-Pred.d.f[,1]
```

```{r Saving the Results}
saveRDS(sim.LowExp,
file = 'Result/similarity_KO_LowExp_DrugTreatment.RDS')
```


# Application

For this section, we will use the information obtained from Core analysis. First, we find a drug's primary target(s). Next, we predict whether the drug specifically targets the wild-type or mutated target forms. We also predict the secondary target(s) that mediate its response when the primary target is not expressed
## Finding a drug primary target

The script below generates the correlation plots for primary target BRAF and MDM2 for Dabrafenib and AMG-232 respectively.

```{r Finding a primary target}
Drug_P_targets <- Pred.d$MaxTargetName
DeepTarget_P <- Pred.d$BestTargetGene
idx <- which (Drug_P_targets==DeepTarget_P)
Pred.d[idx,c(2:6)]
Pred.d[idx,c(2,8:11)]
DOI = 'dabrafenib'
GOI = 'BRAF'
## due to duplicated assay prepare data.
identical(Pred.d$DrugID, row.names(sec.prism.f))
DRS=as.data.frame(sec.prism.f[5,])
DRS <- t(DRS)
row.names(DRS) <- row.names(sec.prism.f)[5]
plotCor(DN=DOI,GN=GOI,Pred=Pred.d[5,],DRS= DRS,GES= KO.GES,plot=TRUE);
## This drug is unique in this Prediction data object.
DOI = 'AMG-232'
GOI = 'MDM2'
identical ( Pred.d$DrugID, row.names(sec.prism.f))
plotCor(DN=DOI,GN=GOI,Pred=Pred.d,DRS=sec.prism.f,GES= KO.GES,plot=TRUE)
```
## Predicting whether the drug specifically targets the wild-type or mutated target forms
The script below shows whether the drugs, CGM097 and Dabrafenib, target the wild-type or mutated
target forms of MDM2 and BRAF respectively from the Prediction object and then generate
the plots for visualization.

```{r Predicting whether the drug specifically targets the wild-type or mutated target forms}
Pred.d.f <- Pred.d[,c(2,3,12:15)]
Pred.d.f.f <- Pred.d.f[which (Pred.d.f$predicted_resistance_mut==TRUE), ]
## plotting second and third rows.
which.mut <- which (Pred.d$predicted_resistance_mut==TRUE);
## dabrafenib
cr.i <- which.mut[2]
DOI =Pred.d[cr.i,2]
GOI =Pred.d[cr.i,3]
DRS=as.data.frame(sec.prism.f[cr.i,])
DRS <- t(DRS)
row.names(DRS) <- row.names(sec.prism.f)[cr.i]
head(DRS)
out <- DMB(DN=DOI,GN=GOI,Pred=Pred.d[cr.i,],
Mutant=d.mt,DRS= DRS,GES= KO.GES,plot=TRUE)
print (out)

## for drug CGM097
cr.i <- which.mut[3]
DOI=Pred.d[cr.i,2]
GOI=Pred.d[cr.i,3]
DRS=as.data.frame(sec.prism.f[cr.i,])
DRS <- t(DRS)
row.names(DRS) <- row.names(sec.prism.f)[cr.i]
head(DRS)
out <- DMB(DN=DOI,GN=GOI,Pred=Pred.d[cr.i,],
Mutant=d.mt,DRS= DRS,GES= KO.GES,plot=TRUE)
print (out)
```

##  Predicting secondary target(s) that mediate its response when the primary target is not expressed
As an example, let's look at the drug 'ibrutinib' from the Prediction object. Ibrutinib is a wellknown
covalent target of BTK. Please note that for this drug, there are two assays. We selected
one of them for illustration.

```{r Predicting secondary target}
## This drug has two assays.
# The index is 14 in the orders of the interesting drugs.
identical (Pred.d$DrugID, row.names(sec.prism.f))
DRS=as.data.frame(sec.prism.f[14,])
DRS <- t(DRS)
row.names(DRS) <- row.names(sec.prism.f)[14]
####
DOI="ibrutinib"
GOI="BTK"
out <- DTR (DN=DOI,GN=GOI,Pred=Pred.d[14,], Exp=d.expr
,DRS= DRS,GES=KO.GES,CutOff= 2)
print(out)
```

We find above that Ibrutinib's response is only correlated with the BTK gene in cell lines
where BTK is expressed and not in cell lines where BTK is not expressed. Next, let's look at the
correlation between the BTK gene KO and this drug response in no BTK cell lines to predict the
secondary targets for this drug. 

```{r Predicting secondary target(s) that mediate its response when the primary target is not expressed}

in.f <- 'Result/similarity_KO_LowExp_DrugTreatment.RDS'
sim.LowExp <- readRDS(file = in.f)
sim.LowExp.Strength=sapply(sim.LowExp, function(x) x[,2])
dim(sim.LowExp.Strength)
sim.LowExp.Pval=sapply(sim.LowExp, function(x) x[,1])
head(sim.LowExp.Pval)
## Let's take a look at ibrutinib
plotSim(dx=sim.LowExp.Pval[,8],dy=sim.LowExp.Strength[,8],
clr=colorRampPalette(c("lightblue",'darkblue')), plot=TRUE)

# The above ranks all the genes based on their secondary DKS Scores.

```

# Conclusion

We observe below that Ibrutinib response is strongly correlated with EGFR knockout (KO) in cell
lines where Bruton’s tyrosine kinase (BTK) is not expressed. However, this correlation is not
observed in cell lines where BTK is expressed. Among the top predicted genes, there’s more layer
of evidence that Ibrutinib binds physically to EGFR. Thus, let’s focus further on EGFR.

```{r Conclusion}
DOI="ibrutinib"
GOI="EGFR"
out <- DTR(DN=DOI,GN=GOI,Pred=Pred.d[14,], Exp=d.expr,
DRS= DRS,GES=KO.GES,CutOff= 2)
print (out)


# The above ranks all the genes based on their secondary DKS Scores.

```


# Session info

```{r session}
sessionInfo()
```

